'''

Tweak the calibration and clean parameters and the mask below to set the values
for an imaging run of the night sky.

To run (in terminal):
casa -c run.py <measurement sets>

'''

from process_ms import *
from casa import *
import numpy as np
import os
# Calibration Parameters
gc                  =   'zen.2458042.50580.xx.HH.uvR.uvfits.msG.cal'
kc                  =   'zen.2458042.50580.xx.HH.uvR.uvfits.msK.cal'
bc                  =   'zen.2458042.50580.xx.HH.uvR.uvfits.mssplit.msB.cal'
bc1                 =   'zen.2458042.50580.xx.HH.uvR.uvfits.mssplit.msc2.msB.cal'
gaintable           =   [kc, gc, bc, bc1]

# Clean Parameters
niter               =   6000
weighting           =   'briggs'
robust              =   -0.5
imsize              =   [512,512]
cell                =   ['250arcsec']
mode                =   'mfs'
nterms              =   1
spw                 =   '0:100~800'
phasecenter         =   ''

img_dir = 'imgs'

if __name__ == '__main__':
    try:
        # Create a variable to hold the filenames of the measurement sets defined
        # by the user and sort them
        folders = sys.argv[3:]
        folders.sort()
        srcs = {'Fornax A': {'DEC': -37.208227, 'RA': 0.8844250908294156},
 'TGSSADR J002430.1-292848': {'DEC': -29.480060577392578,
  'RA': 0.10690892346997534},
 'TGSSADR J002530.4-330346': {'DEC': -33.06296157836914,
  'RA': 0.11129755495269533},
 'TGSSADR J002549.1-260210': {'DEC': -26.036300659179688,
  'RA': 0.11265821388788726},
 'TGSSADR J004441.0-353033': {'DEC': -35.5092887878418,
  'RA': 0.19496829234999247},
 'TGSSADR J013412.0-362915': {'DEC': -36.48754119873047,
  'RA': 0.4110318498791525},
 'TGSSADR J015036.0-293202': {'DEC': -29.53396987915039,
  'RA': 0.4825836979660975},
 'TGSSADR J020012.1-305327': {'DEC': -30.89105987548828,
  'RA': 0.5244791167861382},
 'TGSSADR J021902.9-362609': {'DEC': -36.43608093261719,
  'RA': 0.6067139692698271},
 'TGSSADR J034630.8-342238': {'DEC': -34.37739944458008,
  'RA': 0.988357936388496},
 'TGSSADR J035135.7-274435': {'DEC': -27.743059158325195,
  'RA': 1.0105278203570243},
 'TGSSADR J041300.8-343011': {'DEC': -34.50326156616211,
  'RA': 1.1039834027510576},
 'TGSSADR J041508.9-292904': {'DEC': -29.48444938659668,
  'RA': 1.113297342610419},
 'TGSSADR J042346.9-340240': {'DEC': -34.044471740722656,
  'RA': 1.1509701530745708},
 'TGSSADR J042940.1-363053': {'DEC': -36.514808654785156,
  'RA': 1.1766570075786575},
 'TGSSADR J043300.3-295615': {'DEC': -29.937559127807617,
  'RA': 1.1912131803067583},
 'TGSSADR J044437.6-280950': {'DEC': -28.163949966430664,
  'RA': 1.2419181695652128},
 'TGSSADR J045514.2-300650': {'DEC': -30.113990783691406,
  'RA': 1.288218157222622},
 'TGSSADR J045826.4-300720': {'DEC': -30.122379302978516,
  'RA': 1.3021973561005569},
 'TGSSADR J051330.6-303042': {'DEC': -30.51190948486328,
  'RA': 1.3679472081471415},
 'TGSSADR J052257.7-362735': {'DEC': -36.45975112915039,
  'RA': 1.4091921165814167},
 'TGSSADR J052333.1-325122': {'DEC': -32.85633850097656,
  'RA': 1.4117655291427604},
 'TGSSADR J055615.6-322309': {'DEC': -32.38597106933594,
  'RA': 1.5544820682731801},
 'TGSSADR J060312.0-342635': {'DEC': -34.44322967529297,
  'RA': 1.5847635414479262},
 'TGSSADR J060414.6-315557': {'DEC': -31.93255043029785,
  'RA': 1.5893140848025447},
 'TGSSADR J062706.4-352908': {'DEC': -35.48577880859375,
  'RA': 1.689076099236913},
 'TGSSADR J065857.4-241724': {'DEC': -24.29022979736328,
  'RA': 1.8280471686102453},
 'TGSSADR J071717.6-250454': {'DEC': -25.08169937133789,
  'RA': 1.9080551856589507},
 'TGSSADR J073819.7-302505': {'DEC': -30.418230056762695,
  'RA': 1.9998414321026952},
 'TGSSADR J082126.4-301105': {'DEC': -30.184980392456055,
  'RA': 2.1879452935849537},
 'TGSSADR J082829.2-320024': {'DEC': -32.00679016113281,
  'RA': 2.2186945510051723},
 'TGSSADR J084649.0-294244': {'DEC': -29.71245002746582,
  'RA': 2.2986739390721596},
 'TGSSADR J090147.5-255520': {'DEC': -25.922380447387695,
  'RA': 2.3640161943139075},
 'TGSSADR J092902.6-293020': {'DEC': -29.50581932067871,
  'RA': 2.4829260706698366},
 'TGSSADR J093801.0-291246': {'DEC': -29.21282958984375,
  'RA': 2.5220795987000724},
 'TGSSADR J095804.8-290407': {'DEC': -29.068679809570312,
  'RA': 2.609619035311522},
 'TGSSADR J100911.0-285554': {'DEC': -28.931760787963867,
  'RA': 2.658067261862244},
 'TGSSADR J101348.2-315325': {'DEC': -31.89031982421875,
  'RA': 2.678222597624181},
 'TGSSADR J101809.2-314415': {'DEC': -31.737730026245117,
  'RA': 2.697202946713176},
 'TGSSADR J102011.6-324535': {'DEC': -32.759849548339844,
  'RA': 2.7061109542433823},
 'TGSSADR J103312.9-341845': {'DEC': -34.312530517578125,
  'RA': 2.7629278982035688},
 'TGSSADR J104645.0-360130': {'DEC': -36.02524948120117,
  'RA': 2.8219848269566206},
 'TGSSADR J112554.0-352322': {'DEC': -35.389469146728516,
  'RA': 2.9928090340220095},
 'TGSSADR J113917.1-322235': {'DEC': -32.376609802246094,
  'RA': 3.051207895669703},
 'TGSSADR J114134.5-285052': {'DEC': -28.847980499267578,
  'RA': 3.0612024729246614},
 'TGSSADR J114620.9-315713': {'DEC': -31.953659057617188,
  'RA': 3.08203132212628},
 'TGSSADR J114628.6-332842': {'DEC': -33.47835922241211,
  'RA': 3.0825887217424337},
 'TGSSADR J115421.8-350530': {'DEC': -35.09170913696289,
  'RA': 3.1170004914517837},
 'TGSSADR J120839.2-340305': {'DEC': -34.05144119262695,
  'RA': 3.179354946266572},
 'TGSSADR J125441.2-291348': {'DEC': -29.23004913330078,
  'RA': 3.380212952525329},
 'TGSSADR J140240.0-360351': {'DEC': -36.06435012817383,
  'RA': 3.6768337042094825},
 'TGSSADR J141633.6-364048': {'DEC': -36.68024826049805,
  'RA': 3.737452843257975},
 'TGSSADR J142155.5-310428': {'DEC': -31.07452964782715,
  'RA': 3.7608601650270086},
 'TGSSADR J142249.0-272758': {'DEC': -27.466379165649414,
  'RA': 3.7647529075923774},
 'TGSSADR J142529.1-295956': {'DEC': -29.999000549316406,
  'RA': 3.7763973131426396},
 'TGSSADR J145429.8-364045': {'DEC': -36.679378509521484,
  'RA': 3.9029837513407224},
 'TGSSADR J153158.9-293013': {'DEC': -29.50366973876953,
  'RA': 4.066540990739612},
 'TGSSADR J153353.3-333714': {'DEC': -33.620819091796875,
  'RA': 4.07486043966891},
 'TGSSADR J154402.7-335233': {'DEC': -33.876041412353516,
  'RA': 4.11917517389172},
 'TGSSADR J154859.3-321707': {'DEC': -32.285430908203125,
  'RA': 4.140743050295836},
 'TGSSADR J160512.6-285908': {'DEC': -28.985809326171875,
  'RA': 4.211528806805705},
 'TGSSADR J162555.4-310809': {'DEC': -31.135879516601562,
  'RA': 4.3019053089264165},
 'TGSSADR J163141.1-265649': {'DEC': -26.94713020324707,
  'RA': 4.327042886455675},
 'TGSSADR J165956.9-305205': {'DEC': -30.868139266967773,
  'RA': 4.450366686002301},
 'TGSSADR J170109.7-295441': {'DEC': -29.911630630493164,
  'RA': 4.4556631807782505},
 'TGSSADR J170541.5-321925': {'DEC': -32.32379150390625,
  'RA': 4.4754262329116195},
 'TGSSADR J170624.0-372130': {'DEC': -37.358428955078125,
  'RA': 4.478518695569419},
 'TGSSADR J170745.4-303039': {'DEC': -30.510910034179688,
  'RA': 4.4844346416149214},
 'TGSSADR J170918.4-352520': {'DEC': -35.422279357910156,
  'RA': 4.491203331841467},
 'TGSSADR J171052.3-352813': {'DEC': -35.470359802246094,
  'RA': 4.498031144244212},
 'TGSSADR J171257.3-280936': {'DEC': -28.160070419311523,
  'RA': 4.507117317251344},
 'TGSSADR J171315.6-250228': {'DEC': -25.04129981994629,
  'RA': 4.508451028325256},
 'TGSSADR J171447.8-251437': {'DEC': -25.243730545043945,
  'RA': 4.5151568679500755},
 'TGSSADR J171801.0-372633': {'DEC': -37.44253921508789,
  'RA': 4.529207705861333},
 'TGSSADR J173229.7-353534': {'DEC': -35.592891693115234,
  'RA': 4.592376289021359},
 'TGSSADR J173743.8-313117': {'DEC': -31.521400451660156,
  'RA': 4.615219286955405},
 'TGSSADR J174012.7-305831': {'DEC': -30.975339889526367,
  'RA': 4.626049297844321},
 'TGSSADR J174024.3-305744': {'DEC': -30.962480545043945,
  'RA': 4.6268913893810035},
 'TGSSADR J174306.6-352637': {'DEC': -35.44371032714844,
  'RA': 4.638695051964453},
 'TGSSADR J174545.7-285925': {'DEC': -28.990440368652344,
  'RA': 4.650264356371975},
 'TGSSADR J174751.2-372328': {'DEC': -37.39128875732422,
  'RA': 4.659389411531023},
 'TGSSADR J175659.9-345423': {'DEC': -34.90647888183594,
  'RA': 4.699293684672552},
 'TGSSADR J175943.0-344901': {'DEC': -34.817020416259766,
  'RA': 4.7111564694322015},
 'TGSSADR J180316.9-274813': {'DEC': -27.80364990234375,
  'RA': 4.726711460727136},
 'TGSSADR J182319.4-272628': {'DEC': -27.4412899017334,
  'RA': 4.814163279338722},
 'TGSSADR J182456.6-324305': {'DEC': -32.71818923950195,
  'RA': 4.82122651518183},
 'TGSSADR J183058.8-360231': {'DEC': -36.04207992553711,
  'RA': 4.847565710994932},
 'TGSSADR J183232.4-342240': {'DEC': -34.377891540527344,
  'RA': 4.854374348637828},
 'TGSSADR J185710.6-301943': {'DEC': -30.328739166259766,
  'RA': 4.961871248142223},
 'TGSSADR J191547.0-265259': {'DEC': -26.883100509643555,
  'RA': 5.043056648708852},
 'TGSSADR J191927.5-295802': {'DEC': -29.967439651489258,
  'RA': 5.059094737425528},
 'TGSSADR J192628.1-324245': {'DEC': -32.71268081665039,
  'RA': 5.089681675177306},
 'TGSSADR J193138.4-335444': {'DEC': -33.91231918334961,
  'RA': 5.112247704357983},
 'TGSSADR J195903.7-353434': {'DEC': -35.57622146606445,
  'RA': 5.231896075284191},
 'TGSSADR J203444.5-354850': {'DEC': -35.814170837402344,
  'RA': 5.387580211552479},
 'TGSSADR J203547.5-345404': {'DEC': -34.90121078491211,
  'RA': 5.392159783362979},
 'TGSSADR J205217.6-364031': {'DEC': -36.67549133300781,
  'RA': 5.464161006594361},
 'TGSSADR J211050.6-335113': {'DEC': -33.85369110107422,
  'RA': 5.545101396340704},
 'TGSSADR J211403.3-350240': {'DEC': -35.04460906982422,
  'RA': 5.559115482628918},
 'TGSSADR J211810.6-301915': {'DEC': -30.320959091186523,
  'RA': 5.577101939999096},
 'TGSSADR J212639.7-290100': {'DEC': -29.016769409179688,
  'RA': 5.614125738105596},
 'TGSSADR J213123.1-312113': {'DEC': -31.35379981994629,
  'RA': 5.634734343885064},
 'TGSSADR J221942.5-275626': {'DEC': -27.940780639648438,
  'RA': 5.8455863947665625},
 'TGSSADR J230223.9-371807': {'DEC': -37.302101135253906,
  'RA': 6.031853740361102},
 'TGSSADR J231956.3-272800': {'DEC': -27.466739654541016,
  'RA': 6.1083892616644535},
 'TGSSADR J233648.1-344408': {'DEC': -34.73569107055664,
  'RA': 6.181968674157817},
 'TGSSADR J234145.7-350623': {'DEC': -35.10652160644531,
  'RA': 6.203607390646929},
 'TGSSADR J235700.8-344535': {'DEC': -34.75988006591797,
  'RA': 6.270158721023573}}
	# Check to see that the calibration files exist. If they do not exist,
        # generate them.
        check_f = [os.path.isdir(l) for l in gaintable]
        if not all(check_f):
	    tb.open(os.path.join(folders[0],'SOURCE'))
            angle_ra = tb.getcol('DIRECTION')[0][0]
            angle_dec = tb.getcol('DIRECTION')[1][0]
            ra = convert_angle(angle_ra)
            dec = dd_to_dms(np.rad2deg(angle_dec))
	    tb.close()
            fov = .6206 # HERA field of view in radians
            #Bright sources from Lily's code
            # Fornax, TGSSADR J020012.1-305327, TGSSADR j045514.2-300650, TGSSADR J174024.3-305744 
            mask = 'circle[[' + ra + ', -29d00m00.0s], 32000arcsec]'
	    final_srcs = {k: src for k,src in srcs.iteritems() if angle_ra-fov/2 <= src['RA'] <= angle_ra+fov/2} # check if sources cross into the FOV
            if len(final_srcs) > 0:
                fname = 'mask.rgn'
                with open(fname,'w') as f:
                    f.write('#CRTFv0\n')
                    f.write(mask+'\n')
                    for _,v in final_srcs.iteritems():
                        f.write('circle[[' + convert_angle(v['RA']) + ', ' + dd_to_dms(v['DEC']) + '], 2000arcsec]\n')
                mask = fname
	    gaintable = make_initial_image(folders[0],mask=mask)
            del folders[0]
	# Process each measurement set in the list of measurement sets
   
	for folder in folders:
            # Create the mask for clean
	    tb.open(os.path.join(folder,'SOURCE'))
            angle_ra = tb.getcol('DIRECTION')[0][0]
            angle_dec = tb.getcol('DIRECTION')[1][0]
            ra = convert_angle(angle_ra)
            dec = dd_to_dms(np.rad2deg(angle_dec))
            tb.close()
            fov = .6206 # HERA field of view in radians
            #Bright sources from Lily's code
            # Fornax, TGSSADR J020012.1-305327, TGSSADR j045514.2-300650, TGSSADR J174024.3-305744 
            mask = 'circle[[' + ra + ', -29d00m00.0s], 32000arcsec]'
            final_srcs = {k: src for k,src in srcs.iteritems() if angle_ra-fov/2 <= src['RA'] <= angle_ra+fov/2} # check if sources cross into the FOV
            if len(final_srcs) > 0:
                fname = 'mask.rgn'
                with open(fname,'w') as f:
                    f.write('#CRTFv0\n')
                    f.write(mask+'\n')
                    for _,v in final_srcs.iteritems():
                        f.write('circle[[' + convert_angle(v['RA']) + ', ' + dd_to_dms(v['DEC']) + '], 2000arcsec]\n')
                mask = fname
            make_image(folder,img_dir,gaintable,niter=niter,weighting=weighting,
                       robust=robust, imsize=imsize, cell=cell, mode=mode,
                       nterms=nterms,spw=spw,mask=mask,phasecenter=phasecenter)

    except IndexError:
        print ('File not specified')
